# =============================================================================
# Autonomous AI Issue Resolver - High-Reliability Edition
# Optimized for: Debian 12 | RTX 3070 | Ollama
# =============================================================================

name: Autonomous Aider Agent

on:
  issues:
    types: [opened]

# CRITICAL: Estos permisos permiten al GITHUB_TOKEN realizar push y crear PRs
permissions:
  contents: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  resolve-issue:
    runs-on: self-hosted
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üõ† Diagnostic Check
        run: |
          echo "Directorio actual: $(pwd)"
          echo "Verificando carpeta de scripts:"
          ls -R scripts/ || echo "ERROR: No se encuentra la carpeta scripts"

      - name: Configure Git for Autonomous Agent
        run: |
          git config --global user.name "Aider-Bot"
          git config --global user.email "aider-bot@local.cluster"
          # Permite a git operar en el directorio del runner
          git config --global --add safe.directory "*"

      - name: Execute Aider Orchestrator
        env:
          # Rutas absolutas verificadas en tu sistema
          AIDER_BIN: /home/nromero/.local/bin/aider
          OLLAMA_API_BASE: http://127.0.0.1:11434
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # 1. Crear una rama din√°mica para la soluci√≥n
          BRANCH_NAME="feature/issue-${{ github.event.issue.number }}-auto-resolve"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          
          # 2. Ejecutar el orquestador usando el binario expl√≠cito de Debian
          /usr/bin/python3 ./scripts/agent_orchestrator.py

      - name: Push Branch and Create Pull Request
        if: success()
        env:
          # Token con permisos de escritura habilitados arriba
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Subir la rama al origen remoto
          git push origin ${{ env.BRANCH_NAME }}
          
          # Crear el PR de forma aut√≥noma usando la CLI de GitHub
          gh pr create \
            --title "Fix: ${{ github.event.issue.title }} (Auto-Resolved)" \
            --body "This PR was autonomously generated by the local Aider agent to resolve issue #${{ github.event.issue.number }}." \
            --head ${{ env.BRANCH_NAME }} \
            --base main
