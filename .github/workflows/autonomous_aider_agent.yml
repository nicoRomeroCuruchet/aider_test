# =============================================================================
# Autonomous AI Issue Resolver - Production Grade
# Optimized for: Debian + RTX 3070 + Ollama
# =============================================================================

name: Autonomous Aider Agent

on:
  issues:
    types: [opened]

# Evita colisiones si abres varios issues rápido
concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  resolve-issue:
    # Debe coincidir con la etiqueta de tu runner local
    runs-on: self-hosted
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # Necesario para que Aider analice el historial y el mapa del repo
          fetch-depth: 0

      - name: Configure Git for Agent
        run: |
          git config --global user.name "Aider-Bot"
          git config --global user.email "aider-bot@local.cluster"
          # Evita errores de permisos en directorios de Git
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Execute Aider Orchestrator
        env:
          # REFUERZO DE PATH: Añadimos las rutas comunes donde pipx/curl instalan binarios
          PATH: /home/${{ github.actor }}/.local/bin:/usr/local/bin:/usr/bin:/bin:$PATH
          OLLAMA_API_BASE: "http://127.0.0.1:11434"
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          # 1. Debug: Verificar que el script existe
          if [ ! -f scripts/agent_orchestrator.py ]; then
            echo "ERROR: scripts/agent_orchestrator.py not found in repository."
            exit 1
          fi
          
          # 2. Crear rama para el fix
          BRANCH_NAME="feature/issue-$ISSUE_NUMBER-auto-fix"
          git checkout -b "$BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          
          # 3. Ejecutar orquestador
          python3 scripts/agent_orchestrator.py

      - name: Push and Create Pull Request
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Solo pushear si hubo cambios (Aider hace el commit automáticamente)
          git push origin ${{ env.BRANCH_NAME }}
          
          # Crear el PR usando la GitHub CLI (instalada por defecto en Debian/Runner)
          gh pr create \
            --title "Fix: ${{ github.event.issue.title }} (Auto-Resolved)" \
            --body "This PR was autonomously generated by the local Aider agent using the DGX/RTX cluster to resolve issue #${{ github.event.issue.number }}." \
            --head ${{ env.BRANCH_NAME }} \
            --base main
