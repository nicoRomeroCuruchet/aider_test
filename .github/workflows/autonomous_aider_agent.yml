name: Autonomous Aider Agent
on:
  issues:
    types: [opened]

jobs:
  resolve-issue:
    runs-on: self-hosted
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üõ† Debug Real (Para saber qu√© ve el Runner)
        run: |
          echo "Directorio actual: $(pwd)"
          echo "Contenido de la carpeta scripts:"
          ls -R scripts/ || echo "NO EXISTE LA CARPETA SCRIPTS"

      - name: Configure Git
        run: |
          git config --global user.name "Aider-Bot"
          git config --global user.email "aider-bot@local.cluster"
          git config --global --add safe.directory "*"

      - name: Execute Aider Orchestrator
        env:
          AIDER_BIN: /home/nromero/.local/bin/aider
          OLLAMA_API_BASE: http://127.0.0.1:11434
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Crear rama para el fix
          git checkout -b "feature/issue-${{ github.event.issue.number }}-fix"
          # Ejecuci√≥n con el binario expl√≠cito de Debian
          /usr/bin/python3 ./scripts/agent_orchestrator.py

      - name: Push y PR
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push origin HEAD
          gh pr create --title "Fix: ${{ github.event.issue.title }}" --body "Auto-fix" --base main
